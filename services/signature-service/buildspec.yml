version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - 'bash -lc "set -euo pipefail; echo Using Node: $(node -v); echo Using npm: $(npm -v)"'
      
  pre_build:
    commands:
      - 'echo Building signature-service...'
      - 'echo "Building shared-ts first..."'
      - 'cd ../../packages/shared-ts'
      - 'npm ci'
      - 'DATABASE_URL="postgresql://user:pass@localhost:5432/postgres?schema=public" npx prisma generate'
      - 'npm run build'
      - 'cd -'
      - 'echo "Installing signature-service dependencies..."'
      - 'npm ci'
      - 'echo "Linking shared-ts as local dependency..."'
      - 'npm pkg set dependencies.@lawprotect/shared-ts="file:../../packages/shared-ts"'
      - 'npm install'
      - 'echo "Creating symlink for Jest resolution..."'
      - 'mkdir -p node_modules/@lawprotect'
      - 'ln -sf ../../../packages/shared-ts node_modules/@lawprotect/shared-ts'
      - 'echo "Generating Prisma Client in service..."'
      - 'npx prisma generate --schema ../../packages/shared-ts/prisma/schema.prisma'
      
  build:
    commands:
      - 'cd services/signature-service'
      - 'npm run test:unit:coverage'
      - 'npm run build'
      - 'echo "Cleaning up local shared-ts dependency..."'
      - 'npm prune --omit=dev'
      - 'rm -rf node_modules/@lawprotect/shared-ts'
      - 'echo "Runtime will use Lambda layer for @lawprotect/shared-ts"'
      - |
        handlers=("create-envelope" "get-envelope" "send-envelope" "sign-document" "decline-signer" "share-document" "send-notification" "get-audit-trail" "get-envelopes-by-user" "update-envelope" "cancel-envelope" "download-document")
        for handler in "${handlers[@]}"; do
          echo "Creating sign-$handler.zip..."
          mkdir -p temp-$handler
          cp -r dist/handlers/$handler/* temp-$handler/
          cp package.json temp-$handler/
          cd temp-$handler && zip -r ../sign-$handler.zip . && cd ..
          rm -rf temp-$handler
        done

artifacts:
  files:
    - 'sign-*.zip'
