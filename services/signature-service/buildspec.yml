version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20

  pre_build:
    commands:
      - |
        bash -lc '
        set -euo pipefail
        echo "[INFO] Building packages/shared-ts"
        cd "$CODEBUILD_SRC_DIR/packages/shared-ts"
        npm ci
        export DATABASE_URL="${DATABASE_URL:-postgresql://user:pass@localhost:5432/postgres?schema=public}"
        npm run prisma:generate
        npm run build
        '
      - |
        bash -lc '
        set -euo pipefail
        echo "[INFO] Installing deps in services/signature-service"
        cd "$CODEBUILD_SRC_DIR/services/signature-service"
        npm ci
        '
      - |
        bash -lc '
        set -euo pipefail
        echo "[INFO] Preparing Prisma client"
        cd "$CODEBUILD_SRC_DIR/services/signature-service"
        if [ -d "$CODEBUILD_SRC_DIR/packages/shared-ts/prisma" ]; then
          mkdir -p prisma
          cp -r "$CODEBUILD_SRC_DIR/packages/shared-ts/prisma/"* prisma/
        fi
        export DATABASE_URL="${DATABASE_URL:-postgresql://user:pass@localhost:5432/postgres?schema=public}"
        npx -y prisma@5.22.0 generate
        node -e "try{require.resolve(\"@prisma/client\");console.log(\"@prisma/client OK\")}catch(e){process.exit(1)}"
        node -e "try{require.resolve(\"@lawprotect/shared-ts\");console.log(\"shared-ts OK\")}catch(e){process.exit(1)}"
        '

  build:
    commands:
      - |
        bash -lc '
        set -euo pipefail
        echo "[INFO] Tests"
        cd "$CODEBUILD_SRC_DIR/services/signature-service"
        export DATABASE_URL="${DATABASE_URL:-postgresql://user:pass@localhost:5432/postgres?schema=public}"
        npm run test:unit:coverage
        '
      - |
        bash -lc '
        set -euo pipefail
        echo "[INFO] Build + prune"
        cd "$CODEBUILD_SRC_DIR/services/signature-service"
        npm run build
        npm prune --omit=dev
        rm -rf node_modules/@lawprotect/shared-ts || true
        '
      - |
        bash -lc '
        set -euo pipefail
        echo "[INFO] Package handlers"
        cd "$CODEBUILD_SRC_DIR/services/signature-service"
        
        # Handler mapping
        handlers=(
          "create-envelope:dist/src/handlers/envelopes/CreateEnvelopeHandler.js"
          "get-envelope:dist/src/handlers/envelopes/GetEnvelopeHandler.js"
          "send-envelope:dist/src/handlers/envelopes/SendEnvelopeHandler.js"
          "sign-document:dist/src/handlers/signing/SignDocumentHandler.js"
          "decline-signer:dist/src/handlers/signing/DeclineSignerHandler.js"
          "share-document:dist/src/handlers/signing/ShareDocumentViewHandler.js"
          "send-notification:dist/src/handlers/notifications/SendNotificationHandler.js"
          "get-audit-trail:dist/src/handlers/audit/GetAuditTrailHandler.js"
          "get-envelopes-by-user:dist/src/handlers/envelopes/GetEnvelopesByUserHandler.js"
          "update-envelope:dist/src/handlers/envelopes/UpdateEnvelopeHandler.js"
          "cancel-envelope:dist/src/handlers/envelopes/CancelEnvelopeHandler.js"
          "download-document:dist/src/handlers/envelopes/DownloadDocumentHandler.js"
        )
        
        for handler in "${handlers[@]}"; do
          name="${handler%%:*}"
          src="${handler##*:}"
          [ -f "$src" ] || { echo "Missing handler $src"; exit 1; }
          work="pkg-$name"
          rm -rf "$work"; mkdir -p "$work"
          cp "$src" package.json "$work/"
          (cd "$work" && zip -qr "../sign-$name.zip" .)
          rm -rf "$work"
        done
        '
      - |
        bash -lc '
        set -euo pipefail
        echo "[INFO] Create simple appspec.yml files"
        cd "$CODEBUILD_SRC_DIR/services/signature-service"
        
        echo "[DEBUG] Current directory contents:"
        ls -la
        
        echo "[DEBUG] ZIP files:"
        ls -la sign-*.zip || echo "No ZIP files found"
        
        # Create appspec files with dynamic versions
        functions=(
          "create-envelope:lawprotect365-sign-service-create-envelope-stg"
        )
        
        for func in "${functions[@]}"; do
          name="${func%%:*}"
          function_name="${func##*:}"
          
          echo "[INFO] Creating appspec for $name with dynamic versions"
          
          # Get current version from alias
          CURRENT_VERSION=$(aws lambda get-alias --function-name "$function_name" --name "live" --query FunctionVersion --output text 2>/dev/null || echo "1")
          if [ "$CURRENT_VERSION" = "\$LATEST" ] || [ -z "$CURRENT_VERSION" ] || [ "$CURRENT_VERSION" = "null" ]; then
            CURRENT_VERSION="1"
          fi
          
          # Target version will be current + 1
          TARGET_VERSION=$((CURRENT_VERSION + 1))
          
          echo "[INFO] Function: $function_name, Current: $CURRENT_VERSION, Target: $TARGET_VERSION"
          
          # Create appspec with dynamic versions
          echo "version: 0.0" > "appspec-${name}.yml"
          echo "Resources:" >> "appspec-${name}.yml"
          echo "  - CreateEnvelope:" >> "appspec-${name}.yml"
          echo "      Type: AWS::Lambda::Function" >> "appspec-${name}.yml"
          echo "      Properties:" >> "appspec-${name}.yml"
          echo "        Name: \"$function_name\"" >> "appspec-${name}.yml"
          echo "        Alias: \"live\"" >> "appspec-${name}.yml"
          echo "        CurrentVersion: $CURRENT_VERSION" >> "appspec-${name}.yml"
          echo "        TargetVersion: $TARGET_VERSION" >> "appspec-${name}.yml"
        done
        
        # Create a default appspec.yml for the main function with dynamic versions
        MAIN_FUNCTION="lawprotect365-sign-service-create-envelope-stg"
        CURRENT_VERSION=$(aws lambda get-alias --function-name "$MAIN_FUNCTION" --name "live" --query FunctionVersion --output text 2>/dev/null || echo "1")
        if [ "$CURRENT_VERSION" = "\$LATEST" ] || [ -z "$CURRENT_VERSION" ] || [ "$CURRENT_VERSION" = "null" ]; then
          CURRENT_VERSION="1"
        fi
        TARGET_VERSION=$((CURRENT_VERSION + 1))
        
        echo "[INFO] Main function: $MAIN_FUNCTION, Current: $CURRENT_VERSION, Target: $TARGET_VERSION"
        
        echo "version: 0.0" > "appspec.yml"
        echo "Resources:" >> "appspec.yml"
        echo "  - CreateEnvelope:" >> "appspec.yml"
        echo "      Type: AWS::Lambda::Function" >> "appspec.yml"
        echo "      Properties:" >> "appspec.yml"
        echo "        Name: \"$MAIN_FUNCTION\"" >> "appspec.yml"
        echo "        Alias: \"live\"" >> "appspec.yml"
        echo "        CurrentVersion: $CURRENT_VERSION" >> "appspec.yml"
        echo "        TargetVersion: $TARGET_VERSION" >> "appspec.yml"
        '

artifacts:
  files:
    - services/signature-service/sign-*.zip
    - services/signature-service/appspec.yml
    - services/signature-service/appspec-*.yml
  discard-paths: yes
